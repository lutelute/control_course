<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬14å›ï¼šã‚«ãƒ«ãƒãƒ³ãƒ•ã‚£ãƒ«ã‚¿</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0a1628; --card: #112240; --accent: #64ffda; --blue: #57cbff; --orange: #ffb86c; --pink: #ff79c6; --text: #ccd6f6; --dim: #8892b0; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans JP', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }
        header { text-align: center; padding: 2rem 0; }
        h1 { font-size: 2rem; color: var(--accent); }
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; }
        .card { background: var(--card); border-radius: 12px; padding: 1.5rem; }
        .card-full { grid-column: 1 / -1; }
        .card-title { color: var(--accent); margin-bottom: 1rem; }
        canvas { width: 100%; height: 280px; border-radius: 8px; background: rgba(0,0,0,0.3); }
        .slider-group { margin: 0.8rem 0; }
        .slider-group label { display: flex; justify-content: space-between; color: var(--dim); font-size: 0.9rem; }
        input[type="range"] { width: 100%; margin-top: 0.3rem; }
        .btn { padding: 0.5rem 1rem; background: var(--accent); border: none; border-radius: 6px; color: #0a1628; font-weight: 500; cursor: pointer; margin: 0.2rem; }
        .result-box { background: rgba(100, 255, 218, 0.1); border: 1px solid var(--accent); border-radius: 8px; padding: 1rem; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; margin: 0.5rem 0; }
        .info { background: rgba(87, 203, 255, 0.1); border-left: 3px solid var(--blue); padding: 0.75rem; margin: 0.5rem 0; font-size: 0.9rem; }
        .legend { display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 0.5rem; font-size: 0.85rem; }
        .legend-item { display: flex; align-items: center; gap: 0.3rem; }
        .legend-dot { width: 12px; height: 3px; border-radius: 2px; }
        @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ç¬¬14å›ï¼šã‚«ãƒ«ãƒãƒ³ãƒ•ã‚£ãƒ«ã‚¿</h1>
            <p style="color: var(--dim);">Kalman Filter for State Estimation</p>
        </header>
        
        <div class="grid">
            <div class="card">
                <h3 class="card-title">âš™ï¸ ãƒã‚¤ã‚ºãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</h3>
                <div class="slider-group">
                    <label>ãƒ—ãƒ­ã‚»ã‚¹ãƒã‚¤ã‚º Qw: <span id="qwVal">0.1</span></label>
                    <input type="range" id="qwSlider" min="0.01" max="1" step="0.01" value="0.1">
                </div>
                <div class="slider-group">
                    <label>è¦³æ¸¬ãƒã‚¤ã‚º Rv: <span id="rvVal">0.5</span></label>
                    <input type="range" id="rvSlider" min="0.01" max="2" step="0.01" value="0.5">
                </div>
                <button class="btn" onclick="runSimulation()">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ</button>
                <button class="btn" onclick="resetSimulation()">ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
            
            <div class="card">
                <h3 class="card-title">ğŸ”¢ ã‚«ãƒ«ãƒãƒ³ã‚²ã‚¤ãƒ³</h3>
                <div class="result-box">
                    <div>L = PC<sup>T</sup>R<sub>v</sub><sup>âˆ’1</sup></div>
                    <div id="kalmanGain">L = [0.316, 0.447]</div>
                </div>
                <div class="result-box">
                    <div>å®šå¸¸èª¤å·®å…±åˆ†æ•£ P:</div>
                    <div id="covMatrix">P = [0.158, 0.112; 0.112, 0.224]</div>
                </div>
                <div class="info">
                    Qw å¤§ â†’ L å¤§ï¼ˆè¦³æ¸¬ã‚’ä¿¡é ¼ï¼‰<br>
                    Rv å¤§ â†’ L å°ï¼ˆãƒ¢ãƒ‡ãƒ«ã‚’ä¿¡é ¼ï¼‰
                </div>
            </div>
            
            <div class="card card-full">
                <h3 class="card-title">ğŸ“ˆ çŠ¶æ…‹æ¨å®šï¼ˆxâ‚ï¼‰</h3>
                <canvas id="state1Canvas" style="height: 200px;"></canvas>
                <div class="legend">
                    <div class="legend-item"><div class="legend-dot" style="background: var(--blue);"></div>çœŸã®çŠ¶æ…‹</div>
                    <div class="legend-item"><div class="legend-dot" style="background: var(--accent);"></div>æ¨å®šå€¤</div>
                    <div class="legend-item"><div class="legend-dot" style="background: var(--orange);"></div>è¦³æ¸¬å€¤</div>
                </div>
            </div>
            
            <div class="card">
                <h3 class="card-title">ğŸ“Š æ¨å®šèª¤å·®</h3>
                <canvas id="errorCanvas"></canvas>
                <div class="legend">
                    <div class="legend-item"><div class="legend-dot" style="background: var(--pink);"></div>|x - xÌ‚|</div>
                </div>
            </div>
            
            <div class="card">
                <h3 class="card-title">ğŸ¯ èª¤å·®å…±åˆ†æ•£ã®åæŸ</h3>
                <canvas id="covCanvas"></canvas>
                <div class="legend">
                    <div class="legend-item"><div class="legend-dot" style="background: var(--accent);"></div>Pâ‚â‚(t)</div>
                    <div class="legend-item"><div class="legend-dot" style="background: var(--blue);"></div>Pâ‚‚â‚‚(t)</div>
                </div>
            </div>
            
            <div class="card card-full">
                <h3 class="card-title">âš–ï¸ LQRã¨ã®åŒå¯¾æ€§</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div class="result-box">
                        <strong>LQRï¼ˆåˆ¶å¾¡ï¼‰</strong><br><br>
                        ã‚³ã‚¹ãƒˆ: J = âˆ«(x'Qx + u'Ru)dt<br>
                        ãƒªã‚«ãƒƒãƒ: A'P + PA - PBRâ»Â¹B'P + Q = 0<br>
                        ã‚²ã‚¤ãƒ³: K = Râ»Â¹B'P
                    </div>
                    <div class="result-box">
                        <strong>ã‚«ãƒ«ãƒãƒ³ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆæ¨å®šï¼‰</strong><br><br>
                        èª¤å·®å…±åˆ†æ•£ã®æœ€å°åŒ–<br>
                        ãƒªã‚«ãƒƒãƒ: AP + PA' - PC'Rvâ»Â¹CP + GQwG' = 0<br>
                        ã‚²ã‚¤ãƒ³: L = PC'Rvâ»Â¹
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const A = [[0, 1], [-1, -0.5]];
        const C = [1, 0];
        let Qw = 0.1, Rv = 0.5;
        let simData = null;
        
        const state1Canvas = document.getElementById('state1Canvas');
        const state1Ctx = state1Canvas.getContext('2d');
        const errorCanvas = document.getElementById('errorCanvas');
        const errorCtx = errorCanvas.getContext('2d');
        const covCanvas = document.getElementById('covCanvas');
        const covCtx = covCanvas.getContext('2d');
        
        function setupCanvas(canvas, ctx) {
            const rect = canvas.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
        }
        
        function gaussianRandom() {
            let u = 0, v = 0;
            while (u === 0) u = Math.random();
            while (v === 0) v = Math.random();
            return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
        }
        
        function runSimulation() {
            Qw = parseFloat(document.getElementById('qwSlider').value);
            Rv = parseFloat(document.getElementById('rvSlider').value);
            document.getElementById('qwVal').textContent = Qw.toFixed(2);
            document.getElementById('rvVal').textContent = Rv.toFixed(2);
            
            const dt = 0.05;
            const maxT = 15;
            simData = [];
            
            // çœŸã®çŠ¶æ…‹
            let x1 = 2, x2 = 0;
            // æ¨å®šçŠ¶æ…‹
            let xhat1 = 0, xhat2 = 0;
            // èª¤å·®å…±åˆ†æ•£
            let P11 = 1, P12 = 0, P22 = 1;
            
            // å®šå¸¸ã‚«ãƒ«ãƒãƒ³ã‚²ã‚¤ãƒ³ã®è¨ˆç®—ï¼ˆç°¡æ˜“ï¼‰
            const L1 = Math.sqrt(Qw / Rv) * 0.5 + 0.2;
            const L2 = Math.sqrt(Qw / Rv) * 0.3 + 0.1;
            
            document.getElementById('kalmanGain').textContent = `L = [${L1.toFixed(3)}, ${L2.toFixed(3)}]`;
            
            for (let t = 0; t <= maxT; t += dt) {
                // ãƒ—ãƒ­ã‚»ã‚¹ãƒã‚¤ã‚º
                const w = gaussianRandom() * Math.sqrt(Qw);
                // è¦³æ¸¬ãƒã‚¤ã‚º
                const v = gaussianRandom() * Math.sqrt(Rv);
                
                // è¦³æ¸¬
                const y = C[0]*x1 + C[1]*x2 + v;
                
                // ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³
                const innov = y - (C[0]*xhat1 + C[1]*xhat2);
                
                simData.push({
                    t,
                    x1, x2,
                    xhat1, xhat2,
                    y,
                    error: Math.sqrt((x1-xhat1)**2 + (x2-xhat2)**2),
                    P11, P22
                });
                
                // çœŸã®çŠ¶æ…‹ã®æ›´æ–°
                const dx1 = A[0][0]*x1 + A[0][1]*x2 + w*0.5;
                const dx2 = A[1][0]*x1 + A[1][1]*x2 + w;
                x1 += dx1 * dt;
                x2 += dx2 * dt;
                
                // ã‚«ãƒ«ãƒãƒ³ãƒ•ã‚£ãƒ«ã‚¿æ›´æ–°
                const dxhat1 = A[0][0]*xhat1 + A[0][1]*xhat2 + L1*innov;
                const dxhat2 = A[1][0]*xhat1 + A[1][1]*xhat2 + L2*innov;
                xhat1 += dxhat1 * dt;
                xhat2 += dxhat2 * dt;
                
                // å…±åˆ†æ•£æ›´æ–°ï¼ˆç°¡æ˜“ï¼‰
                const dP11 = 2*A[0][0]*P11 + 2*A[0][1]*P12 + Qw - L1*L1*Rv;
                const dP22 = 2*P12 + 2*A[1][1]*P22 + Qw - L2*L2*Rv;
                P11 = Math.max(0.01, P11 + dP11 * dt * 0.5);
                P22 = Math.max(0.01, P22 + dP22 * dt * 0.5);
            }
            
            const finalP11 = simData[simData.length-1].P11;
            const finalP22 = simData[simData.length-1].P22;
            document.getElementById('covMatrix').textContent = 
                `P = [${finalP11.toFixed(3)}, 0; 0, ${finalP22.toFixed(3)}]`;
            
            drawAll();
        }
        
        function resetSimulation() {
            simData = null;
            drawAll();
        }
        
        function drawState1() {
            const w = state1Canvas.getBoundingClientRect().width;
            const h = state1Canvas.getBoundingClientRect().height;
            state1Ctx.fillStyle = 'rgba(0,0,0,0.3)';
            state1Ctx.fillRect(0, 0, w, h);
            
            if (!simData) return;
            
            const margin = { top: 20, right: 20, bottom: 25, left: 40 };
            const plotW = w - margin.left - margin.right;
            const plotH = h - margin.top - margin.bottom;
            const maxT = 15;
            
            let maxX = 2;
            simData.forEach(d => {
                maxX = Math.max(maxX, Math.abs(d.x1), Math.abs(d.xhat1), Math.abs(d.y));
            });
            
            const toX = (t) => margin.left + (t / maxT) * plotW;
            const toY = (x) => margin.top + plotH/2 - (x / maxX) * (plotH/2) * 0.9;
            
            // ã‚°ãƒªãƒƒãƒ‰
            state1Ctx.strokeStyle = 'rgba(255,255,255,0.1)';
            state1Ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                state1Ctx.beginPath();
                state1Ctx.moveTo(margin.left, margin.top + (plotH/4)*i);
                state1Ctx.lineTo(w - margin.right, margin.top + (plotH/4)*i);
                state1Ctx.stroke();
            }
            
            // è¦³æ¸¬å€¤ï¼ˆç‚¹ï¼‰
            state1Ctx.fillStyle = 'var(--orange)';
            simData.forEach((d, i) => {
                if (i % 3 === 0) {
                    state1Ctx.beginPath();
                    state1Ctx.arc(toX(d.t), toY(d.y), 2, 0, Math.PI * 2);
                    state1Ctx.fill();
                }
            });
            
            // çœŸã®çŠ¶æ…‹
            state1Ctx.strokeStyle = 'var(--blue)';
            state1Ctx.lineWidth = 2;
            state1Ctx.beginPath();
            simData.forEach((d, i) => {
                if (i === 0) state1Ctx.moveTo(toX(d.t), toY(d.x1));
                else state1Ctx.lineTo(toX(d.t), toY(d.x1));
            });
            state1Ctx.stroke();
            
            // æ¨å®šå€¤
            state1Ctx.strokeStyle = 'var(--accent)';
            state1Ctx.lineWidth = 2;
            state1Ctx.beginPath();
            simData.forEach((d, i) => {
                if (i === 0) state1Ctx.moveTo(toX(d.t), toY(d.xhat1));
                else state1Ctx.lineTo(toX(d.t), toY(d.xhat1));
            });
            state1Ctx.stroke();
        }
        
        function drawError() {
            const w = errorCanvas.getBoundingClientRect().width;
            const h = errorCanvas.getBoundingClientRect().height;
            errorCtx.fillStyle = 'rgba(0,0,0,0.3)';
            errorCtx.fillRect(0, 0, w, h);
            
            if (!simData) return;
            
            const margin = { top: 20, right: 20, bottom: 25, left: 40 };
            const plotW = w - margin.left - margin.right;
            const plotH = h - margin.top - margin.bottom;
            const maxT = 15;
            
            let maxErr = 0.1;
            simData.forEach(d => { maxErr = Math.max(maxErr, d.error); });
            
            const toX = (t) => margin.left + (t / maxT) * plotW;
            const toY = (e) => margin.top + plotH - (e / maxErr) * plotH * 0.9;
            
            // èª¤å·®
            errorCtx.strokeStyle = 'var(--pink)';
            errorCtx.lineWidth = 2;
            errorCtx.beginPath();
            simData.forEach((d, i) => {
                if (i === 0) errorCtx.moveTo(toX(d.t), toY(d.error));
                else errorCtx.lineTo(toX(d.t), toY(d.error));
            });
            errorCtx.stroke();
        }
        
        function drawCov() {
            const w = covCanvas.getBoundingClientRect().width;
            const h = covCanvas.getBoundingClientRect().height;
            covCtx.fillStyle = 'rgba(0,0,0,0.3)';
            covCtx.fillRect(0, 0, w, h);
            
            if (!simData) return;
            
            const margin = { top: 20, right: 20, bottom: 25, left: 40 };
            const plotW = w - margin.left - margin.right;
            const plotH = h - margin.top - margin.bottom;
            const maxT = 15;
            
            let maxP = 1;
            simData.forEach(d => { maxP = Math.max(maxP, d.P11, d.P22); });
            
            const toX = (t) => margin.left + (t / maxT) * plotW;
            const toY = (p) => margin.top + plotH - (p / maxP) * plotH * 0.9;
            
            // P11
            covCtx.strokeStyle = 'var(--accent)';
            covCtx.lineWidth = 2;
            covCtx.beginPath();
            simData.forEach((d, i) => {
                if (i === 0) covCtx.moveTo(toX(d.t), toY(d.P11));
                else covCtx.lineTo(toX(d.t), toY(d.P11));
            });
            covCtx.stroke();
            
            // P22
            covCtx.strokeStyle = 'var(--blue)';
            covCtx.beginPath();
            simData.forEach((d, i) => {
                if (i === 0) covCtx.moveTo(toX(d.t), toY(d.P22));
                else covCtx.lineTo(toX(d.t), toY(d.P22));
            });
            covCtx.stroke();
        }
        
        function drawAll() {
            drawState1();
            drawError();
            drawCov();
        }
        
        document.getElementById('qwSlider').addEventListener('input', () => {
            document.getElementById('qwVal').textContent = document.getElementById('qwSlider').value;
        });
        document.getElementById('rvSlider').addEventListener('input', () => {
            document.getElementById('rvVal').textContent = document.getElementById('rvSlider').value;
        });
        
        window.addEventListener('load', () => {
            setupCanvas(state1Canvas, state1Ctx);
            setupCanvas(errorCanvas, errorCtx);
            setupCanvas(covCanvas, covCtx);
            runSimulation();
        });
        window.addEventListener('resize', () => {
            setupCanvas(state1Canvas, state1Ctx);
            setupCanvas(errorCanvas, errorCtx);
            setupCanvas(covCanvas, covCtx);
            drawAll();
        });
    </script>
</body>
</html>
